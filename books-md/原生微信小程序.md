### 开发组成部分

- 页面布局：WXML（类似HTML）
- 页面样式：WXSS（几乎是CSS，某些不支持，某些增强）
- 页面脚本：JavaScript + WXS



### 应用程序结构

APP -> 多个Page -> 多个组件（内置组件、自定义组件）



### 文件结构

[![JpUmgx.md.png](https://s1.ax1x.com/2020/04/14/JpUmgx.md.png)](https://imgchr.com/i/JpUmgx)

#### 入口文件

- 整个 `App` 的入口文件是 `app.json` ；里面的 `pages` 键是一个数组，数组元素为 `App` 的页面，元素先后顺序决定了加载整个 `App` 的页面顺序。



### 小程序架构及配置

#### 常见配置文件

- `project.config.json`
- `sitemap.json`：小程序搜索相关
- `app.json`：全局配置
- `page.json`：页面配置



#### 全局常见配置

| 属性   | 类型     | 必填 | 描述                     |
| ------ | -------- | ---- | ------------------------ |
| pages  | string[] | 是   | 可访问页面及页面加载路径 |
| window | Object   | 否   | 全局的默认窗口表现       |
| tabBar | Object   | 否   | 底部 tab 栏的表现        |



### 小程序的双线程模型

> 宿主环境（微信客户端）为了执行各种文件提供了双线程模型。

- `WXML/WXSS` 运行于渲染层，渲染层使用 `webview`（一个程序有多个页面，因此使用多个 `webview` 渲染）
- `js` 文件运行于逻辑层，使用 `JsCode` 
- 两个线程都是由客户端 `Native` 进行中转。



#### 渲染过程简单概述

`.wxml` + `.js` -（`JsCode`）> `js对象` -> `DOM结构` -(`webview`)> 界面



#### 小程序启动流程

[![JeSmKs.md.png](https://s1.ax1x.com/2020/04/17/JeSmKs.md.png)](https://imgchr.com/i/JeSmKs)



### 初始化小程序

#### 注册 APP 时可进行的操作

1. 判断用户的进入场景。
2. 监听生命周期函数，从而执行相应的业务逻辑。
3. 添加全局共享数据。



### wxss

#### rpx

`responsive pixel`：根据屏幕宽度自适应。

| 设备          | rpx转换px      |
| ------------- | -------------- |
| iphone5       | 1rpx = 0.42px  |
| iphone6       | 1rpx = 0.5px   |
| iphone 6 plus | 1rpx = 0.552px |



### wxml

#### block

> 是一个标签，来包裹组件，不会被渲染。
>
> 在一组组件需要被 `wx:if/wx:for` 进行整体操作时，使用 `block` 标签。



#### wx:for

> 列表渲染



**遍历数字**

```html
<view wx:for="{{3}}">{{item}} {{index}}</view>
```

> item/index：默认是生成的变量名



**修改默认遍历变量名**

```html
<view wx:for="{{3}}" wx:for-item="number" wx:for-index="i">{{number}} - {{i}}</view>
```



#### template

> 模板标签



#### import/include

> 导入



### wxs

> 小程序的脚本语言，结合 `WXML` 构建页面，基本和 `JavaScript` 一致。
>
> 常用于对数据的过滤（时间格式化、数字保留位数等）

![Y3ULJH.png](https://s1.ax1x.com/2020/05/10/Y3ULJH.png)



#### wxs 定义

> 1. 新建 `info.wxs` 文件，在使用的 `wxml` 文件中适用相对路径导入（不可使用绝对路径）
> 2. `info.wxs` 中使用的是 `ES5` 的语法，不支持 `ES6` ，然后使用 `CommonJS` 语法导入。
> 3. 在 `wxml` 文件中使用 `wxs` 标签，需要写上 `module` 属性；此属性是指定使用哪个 `wxs` 里面的数据。

![Y3d6C4.png](https://s1.ax1x.com/2020/05/10/Y3d6C4.png)



### 事件

#### 常见事件类型

![YwkKIA.png](https://s1.ax1x.com/2020/05/13/YwkKIA.png)

1. `touchcancel` 一般在来电时候会触发。
2. `longpress/tap` 两者只会触发一个。
3. 触发 `tap` 时：`touchstart -> touchend -> tap`
4. 触发 `longpress` 时：`touchstart -> longpress -> touchend`



#### 事件对象（event）

![YwE8Hg.png](https://s1.ax1x.com/2020/05/13/YwE8Hg.png)

1. `touches`：记录接触屏幕的总手指个数。
2. `changeTouches`：记录变化的手指个数。（第一根手指按着屏幕，此时 `touches=第一根/changeTouches=第一根` ，此时第一根手指未离开，接着有第二根、第三根手指按住屏幕；此时 `touches=第一、二、三根/changeTouches=第二、三根`）
3. `target\currentTarget`：用于父子元素。
4. `target`：点击子元素时该属性的值是子元素（产生事件的元素）；`currentTarget`：是父元素（触发事件的元素）



#### 事件参数传递

> 使用自定义属性 `data-property` 进行传参。

```react
<view class="item"
      bindtap="handleTap"
      data-index="{{index}}"
      data-item="{{item}}">
      {{item}}
</view>
```

```javascript
handleTap(event) {
  var dataSet = event.currentTarget.dataset;
  var index = dataSet.index;
  var item = dataSet.item;
  console.log(index, item);
}
```



### 自定义组件

> 一般和单个页面的组成一样，有四文件组成：`js/json/wxml/wxss`

1. 在 `自定义.json` 文件中，需要写上 `"component": true` 表明此为自定义组件。

2. 自定义组件命名一般是小写字母+中划线。

3. 在引入的页面的配置文件中（`xxx.json`）配置自定义组件路径（相对/绝对都可）：

   ```json
   {
     "usingComponents": {
       "my-cpn": "/components/my-cpn/my-cpn"
     }
   }
   ```

   `usingComponents`：指当前页面引入的自定义组件。

4. 当自定义组件要在多个页面使用时，可通过全局注册；在 `app.json`：

   ```json
   {
     "usingComponents": {
       "my-cpn": "/components/my-cpn/my-cpn"
     }
   }
   ```

5. 在自定义组件里面，对样式进行编写时最好使用 **类选择器**。

6. 自定义组件及引入自定义组件页面的样式默认是隔离的，要修改此行为可在自定义组件的 js 文件中如下修改

   ```javascript
   Component({
     data: {
       title: 'my-cpn自定义组件'
     },
     options: {
       styleIsolation: "apply-shared"
     }
   })
   ```

   - `apply-shared`： 引入页面可修改自定义组件的样式
   - `shared`： 自定义组件和引入页面可互相修改
   - `page-apply-shared`
   - `page-shared`



### 组件和页面通信

#### 页面传递组件数据和样式

- `properties`：传递数据
- `externalClasses`：传递样式
- `slot`：标签



##### 传递数据

在自定义组件的 js 文件中：

```javascript
properties: {
    title: {
      type: String,
      value: 'my-prop 默认标题',
      observer: function(newVal, oldVal) {
        console.log(newVal, oldVal);
      }
    }
  }
```

1. `title` ：是可根据页面传递的数据动态修改的字段。
2. `value`：字段的默认值。
3. `observer`：观察者，字段每次修改变化时会触发。

在调用的页面 wxml 中：

```html
<my-prop title="标题1" />
<my-prop title="标题2" />
<my-prop /> <!--title会使用默认值-->
```



##### 传递样式

> 类名应该使用 `-` 分隔，不能使用驼峰及大写，不然不会生效。

1. 在自定义组件的 wxml 文件中：

```html
<view>
  <view class="title-class">{{title}}</view>
</view>
```

2. 在自定义组件的 js 文件中：

```javascript
Component({
  externalClasses: ['title-class']
})
```

- `extarnalClasses`：指要从页面动态传入的类名，类型为数组。

3. 在页面的 wxml 文件中：

```html
<my-prop title="标题1" title-class="red" />
<my-prop title="标题2" title-class="blue" />
```

- 因此 `my-prop` 就动态绑定上了类名 `red/blue`

4. 在页面的 wxss 文件中：

```scss
.red {
  color: red;
}

.blue {
  color: blue;
}
```

- **注意：是在页面中，不是在自定义组件中。**



#### 组件传递事件到页面

> 现在自定义组件中捕获事件，然后使用 `this.triggerEvent` 发射事件；接着页面使用 `bind:事件` 获取，最后再进行处理。

1. 在自定义组件 wxml 文件中捕获事件

```html
<button size="mini" bind:tap="handleTap">+1</button>
```

2. 在自定义组件 js文件中发送事件

```javascript
Component({
  methods: {
    handleTap() {
      this.triggerEvent('increment', {}, {})
    }
  }
})
```

- `triggerEvent`：方法接受三个参数；第一个是给父页面捕获到的事件，第二个是随着事件传送出去的数据，可在父页面的 `event` 对象中获取到。

3. 在父页面中捕获组件发送的事件

```html
<my-event bind:increment="handleIncrement" />
```

4. 处理捕获到的事件

```javascript
handleIncrement(event) {
    this.setData({
      count: this.data.count + 1
    })
  }
```



#### 插槽

##### 单个插槽

1. 在自定义组件 wxml 文件中：

```html
<view class='slot'>
  <slot />
</view>
```

2. 在使用自定义组件的页面中：

```html
<自定义组件>
  <button size="mini" slot='slot1'>按钮1</button>
</自定义组件>
```



##### 多个插槽

1. 在自定义组件 wxml 文件中：

```html
<view class='slot'>
  <slot name='slot1' />
  <slot name='slot2' />
  <slot name='slot3' />
</view>
```

- 使用 `name` 属性来指定占位哪个插槽。

2. 在自定义组件 js 文件中：

```javascript
Component({
  options: {
    multipleSlots: true
  }
})
```

- `multipleSlots`：指定当前该自定义组件支持多插槽

3. 在使用自定义组件的页面中：

```html
<w-my-slot>
  <button size="mini" slot='slot1'>按钮1</button>
  <button size="mini" slot='slot2'>按钮2</button>
  <button size="mini" slot='slot3'>按钮3</button>
</w-my-slot>
```

- 在微信组件中，使用 `slot` 属性，指定要占位的插槽。



### 系统API



#### 网络请求

`wx.request(Object, Object)`



**参数**

![YgzK1A.png](https://s1.ax1x.com/2020/05/17/YgzK1A.png)



**封装**

![Y29Clj.png](https://s1.ax1x.com/2020/05/17/Y29Clj.png)



#### 弹窗

1. `showToast`
2. `showModal`
3. `showLoading`
   1. 需要手动调用 `wx.hideLoading` 才会消失，一般用于发起网络请求。
4. `showActionSheet`

```javascript
wx.showToast({});
```



#### 页面分享

> 需要在分享的页面实现页面周期函数，`onShareAppMessage`

```javascript
Page({
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
    return {
      title: 'Hello World',
      path: '/pages/about/about',
      imageUrl: ''
    }
  }
})
```

- `title`：显示分享小程序的标题
- `path`：指定要分享的页面路径（可分享详情页面或基本页面）
- `imageUrl`：指定显示分享页面的封面



> 可通过设置按钮调用分享功能，而不是通过右上角那三个小点。
>
> 不过还是基于页面实现 `onShareAppMessage` 函数的基础上。

```html
<button size='mini' open-type='share'>分享</button>
```



#### 登录流程

![YRdZuD.png](https://s1.ax1x.com/2020/05/17/YRdZuD.png)



#### 页面跳转

> 两种方式： `navigator` 组件和 wx 的 API

**navigator组件**

![YW0qWn.png](https://s1.ax1x.com/2020/05/18/YW0qWn.png)

```html
<navigator url="/pages/about/about">跳到关于页</navigator>
```



`open-type` 属性

> 默认值：`navigate`
>
> 常用值：
>
> 1. `redirect`：关闭当前页面，跳到应用内某个页面；但是不允许跳到 tabbar 页面。
> 2. `switchTab`：跳转到 tabbar 页面，关闭其它非 tabbar 页面。
> 3. `reLaunch`：关闭所有页面，打卡应用中某个页面。
> 4. `navigateBack`：返回



**跳转 API**

- `wx.redirectTo`
- `wx.navigateBack`
- `wx.navigateTo`



#### 页面跳转中的数据传递

**当前页面传递给下个页面**

```html
<navigator url="/pages/about/about?name=Lefkte">跳到关于页</navigator>
```

然后在 `about.js` 的周期函数 `onLoad` 中获取：

```javascript
onLoad: function (options) {
    console.log(options)
  },
```



**当前子页面返回到父页面时传递**

在子页面的 `js` 文件 `onUnload` 周期函数：

```javascript
onUnload: function () {
    // getCurrentPages 获取当前所有页面
    const pages = getCurrentPages();
    // 获取首页对象
    const home = pages[pages.length - 2];
    // 调用页面对象的 setData 更新数据
    home.setData({
      title: 'about'
    })
  },
```



